\documentclass[10pt]{article}

\usepackage{geometry}
\geometry{margin=5em}
\usepackage[export]{adjustbox}
\usepackage{array}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{fancyhdr}
\pagestyle{empty}
\usepackage{lastpage}
\usepackage{xcolor}
\usepackage{enumitem}
\usepackage{pifont}
\usepackage{graphicx}
\graphicspath{{../img}}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18} 
\usepackage{tabularx}
\usepackage{tikz}
\usetikzlibrary{patterns}
\usepackage{luacode}
\newcommand{\rulefilldate}{\parbox[t]{6em}{\centering\hrulefill\\\footnotesize mm/dd/yyyy}}
\newcommand{\studentname}{}
\newcommand{\classtitle}{}
\newcommand{\csvsourceOne}{cc_algebra_2_trig_1_of_2_period_4_grades.csv}
\newcommand{\csvsourceTwo}{Class-Grades-Period4.csv}

\begin{luacode}
local ftcsv = require("ftcsv")
assignmentRecords = ftcsv.parse("\csvsourceOne", {headers=false})
gradeRecords = ftcsv.parse("\csvsourceTwo")
\end{luacode}

\begin{document}
\begin{luacode*}
assignmentLocations = {}
assignmentInfo = {}
titles = assignmentRecords[2]
standardsDue = assignmentRecords[3]

for i, title in pairs(titles) do
	if title ~= "" then
		table.insert(assignmentLocations, i)
	end
end

for j, l in ipairs(assignmentLocations) do 
	local assignment = {}
	assignment.standards = {}
	local offset = 0
	local due
	repeat
		local year, month, day = standardsDue[l+offset]:match("(%d%d%d%d)-(%d%d)-(%d%d)")
		if year ~= nil then
			due = {year=year, month=month, day=day}
			assignment.due=due
		else
			table.insert(assignment.standards, l + offset)
		end
		offset = offset + 1
	until due ~= nil
	table.insert(assignmentInfo, assignment)			
end

for i = 4, #assignmentRecords do
	local record = assignmentRecords[i]
	local email = record[3]
	if email == "" then
		goto continue
	end
	local grade = gradeRecords[i - 3]
	local name = record[2]
	local below4 = {}
	local belowPass = {}
	
	for i, info in ipairs(assignmentInfo) do
		below4[i] = {}
		belowPass[i] = {}
		standards = info.standards
		for j, standard in ipairs(standards) do
			if record[standard] ~= "4" and record[standard] ~= "E" and record[standard] ~= "" then
				if tonumber(record[standard]) and tonumber(record[standard]) < 4 and tonumber(record[standard]) >= 2.5 then
					table.insert(below4[i], standard)
				else
					table.insert(belowPass[i], standard)
				end
			end
		end
	end
		
	local function printGrades(group)
		local count = 0
		for l, standards in pairs(group) do
			if #standards ~= 0 then
				count = count + 1
				tex.print("\\begin{itemize}")
				tex.print("\\item")
				tex.print((titles[assignmentLocations[l]]:gsub("#", "\\#")))
				tex.print("\\begin{itemize}")
					for i, standard in ipairs(standards) do
						tex.print("\\item")
						 local info = standardsDue[standard]
						 tex.print(info:match( "%((.-)%)") .. "\\ \\leaders\\hbox{\\raisebox{0.5ex}{.}}\\hfill\\kern0pt\\ {}" .. record[standard])
					end
				tex.print("\\end{itemize}")
				tex.print("\\end{itemize}")
			end
		end
		if count == 0 then
			tex.print("\\begin{itemize}")
			tex.print("\\item N/A")
			tex.print("\\end{itemize}")
		end
	end
	
	tex.print("\\noindent")
	tex.print("Dear " .. name:gsub("^(.-),%s*(.-)$", "%2 %1") .. ",\\\\[1em]")
	tex.print("\\indent This is your current summary of all revisable Action Opportunities (AOs) in this class as of \\today.  The AOs are grouped by grade, depending on whether they fall below 2.5 or below 4. If you need to revise an AO that is much older than the most recent ones, please use the space below to indicate which AOs you would like to revise. If you are intending to revise an AO outside of the regular in-class revision day, please make an appointment with Dr. Benjamin with the form below. \\textbf{Please be advised that any AO submission without proctoring will not be accepted.}  \\\\[1em] AOs to revise:  \\hrulefill .\\vspace{1em}\\par")	
	tex.print("\\noindent\\hrulefill \\raisebox{-.6ex}{\\textit{\\textbf{Out-of-Class Appointment}}} \\hrulefill")
	tex.print("\\begin{center}")
	tex.print("$\\bullet$ 5th Period, Mon on \\rulefilldate \\hfill $\\bullet$ 5th Period, Wed on \\rulefilldate \\hfill $\\bullet$ After School, Tue on \\rulefilldate") 
	tex.print("\\end{center}\\vspace{.5em} Approved by \\rule{16em}{.4pt}\\par\\vspace{1em}")
	tex.print("\\noindent\\hrulefill \\raisebox{-.6ex}{\\textit{\\textbf{Current Grade Summary}}} \\hrulefill\\vspace{.5em} \\par")
	tex.print("Section Name: " .. grade["Section Name"] .. "\\hfill Section ID: " .. grade["Section External ID"] .. "\\hfill Current Grade: " .. grade["Conversion"] .. "/100")
	tex.print("\\begin{itemize}\\footnotesize")
	tex.print("\\item Below 2.5")
	printGrades(belowPass)
	tex.print("\\item Below 4")
	printGrades(below4)
	tex.print("\\end{itemize}")
	tex.print("\\clearpage")
	tex.print("\\input{binder-check-rubric}\\clearpage")
	::continue::
end
\end{luacode*}

\end{document}