\documentclass[12pt]{article}

\usepackage{geometry}
\geometry{margin=3em}
\usepackage[export]{adjustbox}
\usepackage{array}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{fancyhdr}
\pagestyle{empty}
\usepackage{lastpage}
\usepackage{xcolor}
\usepackage{enumitem}
\usepackage{pifont}
\usepackage{graphicx}
\graphicspath{{../img}}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18} 
\usepackage{tabularx}
\usepackage{tikz}
\usetikzlibrary{patterns}
\usepackage{luacode}
\newcommand{\studentname}{}
\newcommand{\classtitle}{}
\newcommand{\csvsource}{pre_calculus_grade.csv}

\begin{luacode}
local ftcsv = require("ftcsv")
records = ftcsv.parse("\csvsource", {headers=false})
\end{luacode}

\begin{document}
\begin{luacode*}
assignmentLocations = {}
assignmentInfo = {}
titles = records[2]
for i, e in pairs(titles) do
	if e ~= "" then
		table.insert(assignmentLocations, i)
	end
end
for j, l in ipairs(assignmentLocations) do 
	local assignment = {}
	local k = 0
	local due
	repeat
		local year, month, day = records[3][l+k]:match("(%d%d%d%d)-(%d%d)-(%d%d)")
		if year ~= nil then
			due = {year=year, month=month, day=day}
			assignment.due=due
		else
			assignment[l+k] = records[3][l+k]
		end
		k = k+1
	until due ~= nil
	table.insert(assignmentInfo, assignment)			
end
for i = 4, #records do
	local record = records[i]
	local below4 = {}
	local belowPass = {}
	tex.print("\\noindent")
	tex.print(record[2])
	for j, l in ipairs(assignmentLocations) do
		below4[l] = {}
		belowPass[l] = {}
		for k, info in pairs(assignmentInfo[j]) do
			if k ~= "due" then
				if record[k] ~= "4" then
					if tonumber(record[k]) and tonumber(record[k]) < 4 and tonumber(record[k]) >= 2.5 then
						table.insert(below4[l], k)
					else
						table.insert(belowPass[l], k)
					end						
				end
			end
		end	
	end
	tex.print("\\begin{itemize}")
	tex.print("\\item Below 4")
	for l, standards in pairs(below4) do
		if #standards ~= 0 then
			tex.print("\\begin{itemize}")
			tex.print("\\item")
			tex.print((titles[l]:gsub("#", "\\#")))
			tex.print("\\begin{itemize}")
				for i, k in ipairs(standards) do
					tex.print("\\item")
					 local info = records[3][k]
					 tex.print(info:match( "%((.-)%)") .. "\\hfill " .. record[k])
				end
			tex.print("\\end{itemize}")
			tex.print("\\end{itemize}")
		end
	end
	tex.print("\\item Below Pass")
	for l, standards in pairs(belowPass) do
		if #standards ~= 0 then
			tex.print("\\begin{itemize}")
			tex.print("\\item")
			tex.print((titles[l]:gsub("#", "\\#")))
			tex.print("\\begin{itemize}")
				for i, k in ipairs(standards) do
					tex.print("\\item")
					 local info = records[3][k]
					 tex.print(info:match( "%((.-)%)") .. "\\hfill " .. record[k])
				end
			tex.print("\\end{itemize}")
			tex.print("\\end{itemize}")
		end
	end
	tex.print("\\end{itemize}")
	-- tex.print(info:match( "%((.-)%)") .. "\\hfill " .. record[k])			
	-- tex.print((titles[l]:gsub("#", "\\#")))
	tex.print("\\clearpage")
end
\end{luacode*}

\end{document}