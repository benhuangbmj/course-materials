\begin{luacode}
violationEnd = 7
local ftcsv = require("ftcsv")
behaviorRecords = ftcsv.parse("\csvsourcebehavior", {headers=false})
headers = behaviorRecords[1]
function printHeaders(start, endCount)
	for i = start, endCount do
		tex.print(headers[i])
		if i ~= endCount then
			tex.print("&")
		else 
		 	tex.print("\\\\ \\hline")
		end
	end
end
function printRecord(record, start, endCount)
	for i = start, endCount do
		tex.print(record[i])
		if i ~= endCount then
			tex.print("&")
		else 
		 	tex.print("\\\\ \\hline")
		end
	end
end
function printStudentName(record)
tex.print("Name: " .. record[1])
end
function printClass(record)
	tex.print("Class: " .. record[2])
end
function getTotalViolations(record)
	local total = 0
	for i = 3, violationEnd do
		total = total + tonumber(record[i])
	end
	return total
end
function getTotalParticipation(record)
	local total = 0
	for i = 9,10 do
		total = total + tonumber(record[i])
	end
	return total
end
function congregate(records, calculate, predicate)
	if predicate == nil then
		predicate = function() return true end
	end
	local classTotal = 0
	local count = 0
	for i = 2, #records do
		if predicate(records[i]) then
			local total = calculate(records[i])
			classTotal = classTotal + total
			count = count + 1
		end
	end
	return {classTotal, count}
end
\end{luacode}
\begin{luacode*}
function printBehaviorReport(record)
	local classTitle = record[2]
	local function isSameClass(comp)
		if comp[2] == classTitle then
			return true
		else
			return false
		end
	end
	averageViolations = math.floor(congregate(behaviorRecords, getTotalViolations, isSameClass)[1]/congregate(behaviorRecords, getTotalViolations, isSameClass)[2])
	averageParticipation =math.floor(congregate(behaviorRecords, getTotalParticipation, isSameClass)[1]/congregate(behaviorRecords, getTotalViolations, isSameClass)[2])
	tex.print("\\noindent\\textbf{Report Period: Nov 25th 2025 - Dec 18th 2025}\\par\\vspace{.5em}\\footnotesize")
	printStudentName(record)
	tex.print("\\quad")
	printClass(record)
	tex.print("\\par\\vspace{.5em} Records of Classroom Norm Violation:\\par\\vspace{1em}")
	tex.print("\\renewcommand{\\arraystretch}{2}\\begin{tabularx}{.6\\textwidth}{|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|}")
	tex.print("\\hline")
	printHeaders(3, violationEnd)
	printRecord(record, 3, violationEnd)
	tex.print("\\end{tabularx}\\par\\vspace{1em}")
	tex.print("Total Violation in This Report Period: " .. getTotalViolations(record) .. "\\par")
	tex.print("Class Average Violation in This Report Period: " .. averageViolations .. "\\par\\vspace{1em}")
	tex.print("\\par Records of Active Class Participation:\\par\\vspace{1em}")
	tex.print("\\renewcommand{\\arraystretch}{2}\\begin{tabularx}{.6\\textwidth}{|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|>{\\centering\\arraybackslash}X|}")
	tex.print("\\hline")
	printHeaders(9, 10)
	printRecord(record, 9, 10)
	tex.print("\\end{tabularx}\\par\\vspace{1em}")
	tex.print("Total Participation in This Report Period: " .. getTotalParticipation(record) .. "\\par")
	tex.print("Class Average Participation in This Report Period: " .. averageParticipation .. "\\par")
	tex.print('\\vspace{1em}\\normalsize\\input{"self-evaluation.tex"}\\clearpage')
end
\end{luacode*}